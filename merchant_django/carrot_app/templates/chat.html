{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" type="text/css" href="{% static 'css/reset.css' %}" />
  <link rel="stylesheet" type="text/css" href="{% static 'css/global.css' %}" />
  <link rel="stylesheet" type="text/css" href="{% static 'css/test.css' %}" />
  <link rel="stylesheet" type="text/css" href="{% static 'css/nav.css' %}" />
  <link rel="stylesheet" type="text/css" href="{% static 'css/footer.css' %}" />
  <link rel="stylesheet" type="text/css" href="{% static 'css/chat.css' %}" />
  <title>채팅하기</title>
</head>

<body class="back-ye">
  {% include 'nav.html' %}
  <div class="content-box">
    <div class="container column">
      <div class="post-box flex-box">
        <!-- 채팅선택창 -->
        <div class="chat-select-container">
          <div class="flex-box">
            <!-- 아이디및 체크박스 -->
            <div class="id-box flex-box between">
              아이디
              <div>
                <label>
                  안읽은 메세지만 보기
                  <input type="checkbox" id="unreadMessagesCheckbox" name="">
                </label>
              </div>
            </div>
          </div>
          <!-- 채팅 리스트 -->
          <div class="chat-list-box flex-box column">
            <!-- 국왕 클릭 시 채팅창 열기 -->
            <div class="flex-box chat-box between user-chat-button" data-user-id="1">
              <div>
                <div class="flex-box">
                  <p class="bold">국왕</p>
                  <p class="s-text">장고나라</p>
                  <p class="s-text">3주전</p>
                </div>
                <p class="chat-thumb-text">거래 잘 하셨나요? 거래한 이웃..</p>
              </div>
              <div class="thumbnail-box">
                <img src="" alt="">
              </div>
            </div>

            <!-- 왕비 클릭 시 채팅창 열기 -->
            <div class="flex-box chat-box between user-chat-button" data-user-id="2">
              <div>
                <div class="flex-box">
                  <p class="bold">왕비</p>
                  <p class="s-text">장고나라</p>
                  <p class="s-text">1일 전</p>
                </div>
                <p class="chat-thumb-text">상품에 대한 문의가 있어요.</p>
              </div>
              <div class="thumbnail-box">
                <img src="" alt="">
              </div>
            </div>

            <!-- 첫째공주 클릭 시 채팅창 열기 -->
            <div class="flex-box chat-box between user-chat-button" data-user-id="3">
              <div>
                <div class="flex-box">
                  <p class="bold">첫째공주</p>
                  <p class="s-text">장고나라</p>
                  <p class="s-text">2일 전</p>
                </div>
                <p class="chat-thumb-text">상품 가격을 조정하려고 합니다.</p>
              </div>
              <div class="thumbnail-box">
                <img src="" alt="">
              </div>
            </div>

            <!-- 박봉 클릭 시 채팅창 열기 -->
            <div class="flex-box chat-box between user-chat-button" data-user-id="4">
              <div>
                <div class="flex-box">
                  <p class="bold">박봉</p>
                  <p class="s-text">거상</p>
                  <p class="s-text">3일 전</p>
                </div>
                <p class="chat-thumb-text">배송일정을 확인해주세요.</p>
              </div>
              <div class="thumbnail-box">
                <img src="" alt="">
              </div>
            </div>
          </div>
        </div>
        <!-- 채팅창-->
        <div class="chat-main-container">
          <div>
            <div class="contact-info flex-box">
              <div class="user-id-placeholder"> <!-- 사용자 아이디를 표시할 곳 -->
              </div>
              <div class="temp">
                36.9도
              </div>
            </div>
            <!--물품정보-->
            <div class="goods-box flex-box between">
              <div class="flex-box">
                <div class="selected-thumbnail-box">
                  <img src="" alt="">
                </div>
                <div class="goods-info-box">
                  <p>국왕</p>
                  <p class="bold">장고나라</p>
                </div>
              </div>
              <button>거래완료</button>
            </div>
            <!--채팅창 메인-->
            <div class="chat-container">
              <!-- 메시지가 표시될 곳 -->
            </div>
          </div>
          <form class="chat-input" action="submit">
            <textarea name="" id="" cols="30" rows="10" placeholder="메세지를 입력해주세요"></textarea>
            <div>
              <button>전송</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  {% include 'footer.html' %}
</body>
<script>
  const chatForm = document.querySelector(".chat-input");
  const messageInput = chatForm.querySelector("textarea");
  const chatBox = document.querySelector(".chat-container");

  // 사용자 아이디와 WebSocket 경로 설정
  const userId = "국왕"; // 사용자 아이디 설정
  const wsPath = `ws://${window.location.host}/ws/chat/test/`;

  // WebSocket 연결
  const chatSocket = new WebSocket(wsPath);

  chatSocket.onmessage = function (e) {
    const data = JSON.parse(e.data);
    const message = data.message;

    // 받은 메시지를 채팅창에 표시
    const messageBox = document.createElement("div");
    messageBox.classList.add("message-box");
    messageBox.classList.add("from-other");
    messageBox.innerHTML = `
      <div class="message-text">${message}</div>
      <p class="s-text">${getCurrentTime()}</p>
    `;
    chatBox.appendChild(messageBox);
  };

  chatSocket.onclose = function (e) {
    console.error("WebSocket closed unexpectedly");
  };

  chatForm.addEventListener("submit", function (event) {
    event.preventDefault();
    const message = messageInput.value.trim();
    if (message) {
      chatSocket.send(JSON.stringify({ message: message }));
      messageInput.value = "";

      // 보낸 메시지를 채팅창에 표시
      const messageBox = document.createElement("div");
      messageBox.classList.add("message-box");
      messageBox.classList.add("from-me");
      messageBox.innerHTML = `
        <p class="s-text">${getCurrentTime()}</p>
        <div class="message-text">${message}</div>
      `;
      chatBox.appendChild(messageBox);
    }
  });

  function getCurrentTime() {
    const now = new Date();
    const hours = now.getHours().toString().padStart(2, "0");
    const minutes = now.getMinutes().toString().padStart(2, "0");
    return `${hours}:${minutes}`;
  }
</script>

</html>